var D=Object.defineProperty;var k=(i,t,e)=>t in i?D(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var r=(i,t,e)=>k(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const h of n)if(h.type==="childList")for(const a of h.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const h={};return n.integrity&&(h.integrity=n.integrity),n.referrerPolicy&&(h.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?h.credentials="include":n.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(n){if(n.ep)return;n.ep=!0;const h=e(n);fetch(n.href,h)}})();var o;(function(i){i[i.Empty=0]="Empty",i[i.LightBlue=1]="LightBlue",i[i.DarkBlue=2]="DarkBlue",i[i.Orange=3]="Orange",i[i.Yellow=4]="Yellow",i[i.Green=5]="Green",i[i.Red=6]="Red",i[i.Magenta=7]="Magenta"})(o||(o={}));var c;(function(i){i[i.Left=0]="Left",i[i.Right=1]="Right",i[i.Down=2]="Down"})(c||(c={}));const b={ArrowLeft:c.Left,ArrowRight:c.Right,ArrowDown:c.Down};var f;(function(i){i[i.North=0]="North",i[i.East=90]="East",i[i.South=180]="South",i[i.West=270]="West"})(f||(f={}));var l;(function(i){i[i.Menu=0]="Menu",i[i.Running=1]="Running",i[i.Paused=2]="Paused",i[i.GameOver=3]="GameOver"})(l||(l={}));const S=20,L=10,P={[o.Empty]:"black",[o.LightBlue]:"#00BCD4",[o.DarkBlue]:"#3F51B5",[o.Orange]:"#FF9800",[o.Yellow]:"#FFEB3B",[o.Green]:"#4CAF50",[o.Red]:"#D32F2F",[o.Magenta]:"#AD1457"},O=500,A=60,p=1/128,B=1.4,C=1/8,M=10;class I{constructor(t){r(this,"tileSize");r(this,"fieldCtx");r(this,"fieldPixels");r(this,"nextCtx");r(this,"nextPixels");r(this,"levelDisplay");r(this,"scoreDisplay");const e=t.fieldCanvas.getContext("2d"),s=t.nextCanvas.getContext("2d");if(this.fieldPixels=[t.fieldCanvas.width,t.fieldCanvas.height],this.nextPixels=[t.nextCanvas.width,t.nextCanvas.height],!e||!s)throw Error("Unable to get canvas context!");this.fieldCtx=e,this.nextCtx=s,this.tileSize=Math.floor(this.fieldPixels[0]/(t.width?t.width:L)),this.levelDisplay=document.getElementById("levelDisplay"),this.scoreDisplay=document.getElementById("scoreDisplay")}printScore(t){this.scoreDisplay.textContent=`${t}`}printLevel(t){this.levelDisplay.textContent=`${t}`}drawGame(t){for(let e=0;e<t.height;e++)for(let s=0;s<t.width;s++)this.fieldCtx.fillStyle=P[t.get(s,e)],this.fieldCtx.fillRect(s*this.tileSize,e*this.tileSize,this.tileSize,this.tileSize)}drawNext(t){if(this.blankCanvas(this.nextCtx),!t)return;t.width*this.tileSize,t.height*this.tileSize;const e=(this.nextPixels[0]-t.width*this.tileSize)/2,s=(this.nextPixels[1]-t.height*this.tileSize)/2;for(let n=0;n<t.height;n++)for(let h=0;h<t.width;h++)this.nextCtx.fillStyle=P[t.get(h,n)],this.nextCtx.fillRect(e+h*this.tileSize,s+n*this.tileSize,this.tileSize,this.tileSize)}drawTextOverlay(t,e){this.drawGame(t),this.fieldCtx.save(),this.fieldCtx.fillStyle="rgba(0, 0, 0, .65)",this.fieldCtx.fillRect(0,0,this.fieldPixels[0],this.fieldPixels[1]),this.fieldCtx.fillStyle="white",this.fieldCtx.font="bold 16pt sans-serif",this.fieldCtx.textAlign="center";const s=this.fieldPixels[0]/2,n=this.fieldPixels[1]*.33;this.fieldCtx.fillText(e,s,n),this.fieldCtx.restore()}drawMenu(){this.blankCanvas(this.fieldCtx),this.fieldCtx.fillStyle="white",this.fieldCtx.font="bold 12pt sans-serif",this.fieldCtx.textAlign="center";const t=this.fieldPixels[0]/2,e=this.fieldPixels[1]*.33;this.fieldCtx.fillText("Press Enter to start",t,e)}blankCanvas(t){const[e,s]=t===this.fieldCtx?this.fieldPixels:this.nextPixels;t.save(),t.fillStyle="black",t.fillRect(0,0,e,s),t.restore()}}class u{constructor(t,e,s){r(this,"tiles");r(this,"height");r(this,"width");r(this,"get",(t,e)=>this.tiles[e*this.width+t]);this.tiles=Array.from(t),this.height=s,this.width=e}static newEmpty(t,e){const s=Array(t*e).fill(o.Empty);return new u(s,t,e)}overlay(t,e){const s=new u(this.tiles,this.width,this.height);let n;e?n=e:n=t instanceof v&&t.position?[t.position[0],Math.floor(t.position[1])]:[0,0];for(let h=n[1],a=0;h<this.height&&a<t.height;h++,a++)for(let d=n[0],g=0;d<this.width&&g<t.width;d++,g++){const m=t.get(g,a);m!=o.Empty&&(s.tiles[h*this.width+d]=m.valueOf())}return s}intersects(t,e){const s=e||[0,0],n=Math.floor(s[1]),h=s[0];for(let a=0;a<this.height;a++)for(let d=0;d<this.width;d++)if(this.get(d,a)!=o.Empty&&t.get(h+d,n+a)!=o.Empty)return!0;return!1}clearRows(t){let e=Array(t.length*this.width).fill(o.Empty);const s=t.map(h=>h*this.width),n=this.tiles.length-this.width;for(let h=0;h<=n;h+=this.width)if(!s.includes(h)){const a=this.tiles.slice(h,h+this.width);e=e.concat(a)}this.tiles=e}getFullRows(){return[...Array(this.height).keys()].filter(e=>this.tiles.slice(e*this.width,e*this.width+this.width).every(s=>s!=o.Empty))}inBoundsOf(t,e){const s=e||[0,0];return s[0]>=0&&s[1]>=0&&s[0]<=t.width-this.width&&Math.floor(s[1])<=t.height-this.height}}const y=(i,t)=>i.flatMap(e=>e.map(s=>s?t.valueOf():o.Empty)),F=i=>i[0].map((t,e)=>i.map(s=>s[e])),x=i=>F(i).map(t=>N(t)),N=i=>{const t=Array.from(i);return t.reverse(),t},G=(i,t)=>(i%t+t)%t;class v{constructor(t,e){r(this,"orientation",f.North);r(this,"tiles");r(this,"width");r(this,"height");r(this,"position");r(this,"get",(t,e)=>this.tiles[this.orientation].get(t,e));this.width=t[0].length,this.height=t.length;const s=x(t),n=x(s),h=x(n),a=y(t,e),d=y(s,e),g=y(n,e),m=y(h,e);this.tiles={[f.North]:new u(a,this.width,this.height),[f.East]:new u(d,this.height,this.width),[f.South]:new u(g,this.width,this.height),[f.West]:new u(m,this.height,this.width)}}getRotation(t){return G(this.orientation+t,360)}intersects(t){return this.position?this.tiles[this.orientation].intersects(t,this.position):!1}overlay(t,e){return this.tiles[this.orientation].overlay(t,e)}inBoundsOf(t,e){const s=e||this.position;return this.tiles[this.orientation].inBoundsOf(t,s)}}const w={templates:[{name:"T",color:o.Magenta,matrix:[[!1,!0,!1],[!0,!0,!0]]},{name:"I",color:o.LightBlue,matrix:[[!0,!0,!0,!0]]},{name:"O",color:o.Yellow,matrix:[[!0,!0],[!0,!0]]},{name:"J",color:o.DarkBlue,matrix:[[!0,!1,!1],[!0,!0,!0]]},{name:"L",color:o.Orange,matrix:[[!1,!1,!0],[!0,!0,!0]]},{name:"S",color:o.Green,matrix:[[!1,!0,!0],[!0,!0,!1]]},{name:"Z",color:o.Red,matrix:[[!0,!0,!1],[!1,!0,!0]]}],randomBag:[0,1,2,3,4,5,6,7],currentIndex:0,shuffle:function(){for(let i=this.randomBag.length-1;i--;i>0){const t=Math.floor(Math.random()*(i+1));[this.randomBag[i],this.randomBag[t]]=[this.randomBag[t],this.randomBag[i]]}this.currentIndex=0},getNext:function(){return this.currentIndex===this.randomBag.length-1&&this.shuffle(),this.getByIdx(this.randomBag[this.currentIndex++])},getByName:function(i){const t=this.templates.find(e=>{e.name});return t===void 0?void 0:new v(t.matrix,t.color)},getByIdx:function(i){const t=this.templates[i];return new v(t.matrix,t.color)}},E=(i,t,e)=>{if(!i.position)return;const s=[...i.position];switch(e){case c.Left:s[0]--;break;case c.Right:s[0]++;break;case c.Down:s[1]++;break}if(!(!i.inBoundsOf(t.tiles,s)||i.tiles[i.orientation].intersects(t.tiles,s)))return s},_=(i,t,e)=>{if(i.position===void 0)return;const s=i.getRotation(e);i.tiles[s];const n=Math.min(i.position[0],t.width-i.tiles[s].width);if(i.tiles[s].inBoundsOf(t.tiles,[n,i.position[1]])&&!i.tiles[s].intersects(t.tiles,i.position))return[s,[n,i.position[1]]]},z=(i,t,e)=>E(i,t,e)===void 0;class R{constructor(t,e){r(this,"tiles");r(this,"height");r(this,"width");r(this,"overlay",(t,e)=>t!==void 0?this.tiles.overlay(t,e):this.tiles);r(this,"get",(t,e)=>this.tiles.get(t,e));r(this,"getFullRows",()=>this.tiles.getFullRows());[this.width,this.height]=[t||L,e||S];const s=Array(this.width*this.height).fill(o.Empty);this.tiles=new u(s,this.width,this.height)}clearRows(t){this.tiles.clearRows(t)}}const T=(i,t)=>{switch(i){case 4:return 1200*(t+1);case 3:return 300*(t+1);case 2:return 100*(t+1);case 1:return 40*(t+1);default:return 0}};class Y{constructor(t){r(this,"pf");r(this,"renderer");r(this,"currentPiece");r(this,"nextPiece");r(this,"state",l.Menu);r(this,"score",0);r(this,"gravity",p);r(this,"softDrop",!1);r(this,"frameDelay",1/A*.8);r(this,"lockTimeout");r(this,"level",1);r(this,"levelProgress",0);this.pf=new R(t.width,t.height),this.renderer=new I({fieldCanvas:t.fieldCanvas,nextCanvas:t.nextCanvas})}reset(){this.pf=new R(this.pf.width,this.pf.height),w.shuffle(),this.currentPiece=w.getNext(),this.nextPiece=w.getNext(),this.state=l.Running,this.score=0,this.level=1,this.renderer.printLevel(this.level),this.renderer.printScore(this.score),this.gravity=p,this.softDrop=!1,this.renderer.blankCanvas(this.renderer.fieldCtx),this.renderer.blankCanvas(this.renderer.nextCtx)}lockPiece(){if(this.currentPiece===void 0||this.currentPiece.position===void 0)return;if(this.currentPiece.position[1]<1){this.state=l.GameOver;return}this.pf.tiles=this.pf.overlay(this.currentPiece),this.currentPiece=this.nextPiece,this.nextPiece=w.getNext();const t=this.pf.getFullRows(),e=t.length;e>0&&(this.pf.clearRows(t),this.score+=T(this.level,e),this.maybeNextLevel(e),this.renderer.printScore(this.score),this.renderer.printLevel(this.level))}move(t){if(this.currentPiece===void 0||this.currentPiece.position===void 0)return;const e=E(this.currentPiece,this.pf,t);e&&(this.currentPiece.position=e)}isPieceLanded(){return!this.currentPiece||!this.currentPiece.position?!1:z(this.currentPiece,this.pf,c.Down)}hardDrop(){for(;!this.isPieceLanded();)this.move(c.Down);this.lockPiece()}rotate(t){if(!this.currentPiece)return;const e=_(this.currentPiece,this.pf,t);e!==void 0&&(this.currentPiece.orientation=e[0],this.currentPiece.position=e[1],this.currentPiece.width=this.currentPiece.tiles[e[0]].width,this.currentPiece.height=this.currentPiece.tiles[e[0]].height)}handleKeyDown(t){switch(t.code){case"ArrowLeft":case"ArrowRight":if(this.state!=l.Running)return;this.move(b[t.code]);break;case"ArrowDown":if(this.state!=l.Running)return;this.gravity<1&&(this.softDrop=!0),this.isPieceLanded()&&this.lockPiece();break;case"Space":if(this.state!=l.Running)return;this.hardDrop();break;case"ArrowUp":if(this.state!=l.Running||!this.currentPiece)return;this.rotate(90);break;case"KeyZ":if(this.state!=l.Running||!this.currentPiece)return;this.rotate(-90);break;case"Pause":case"KeyP":switch(this.state){case l.Running:this.state=l.Paused;break;case l.Paused:this.state=l.Running;break}break;case"Enter":[l.Menu,l.GameOver].includes(this.state)&&this.reset();break;case"NumpadAdd":this.gravity=Math.min(this.pf.height,this.gravity*2),console.log(`new gravity: ${this.gravity}`);break;case"NumpadSubtract":this.gravity=Math.max(p,this.gravity/2),console.log(`new gravity: ${this.gravity}`);break}}handleKeyUp(t){switch(t.code){case"ArrowDown":this.softDrop=!1;break}}doFall(){if(!(this.currentPiece===void 0||this.currentPiece.position===void 0))if(this.gravity<1)this.currentPiece.position[1]+=this.softDrop&&this.gravity<C?C:this.gravity;else{const t=Math.floor(this.gravity);let e;for(e=0;e<t&&!this.isPieceLanded();e++)this.move(c.Down);const s=this.gravity-e;this.isPieceLanded()||(this.currentPiece.position[1]+=s)}}maybeNextLevel(t){this.levelProgress+=t,this.levelProgress>=M&&(this.level++,this.levelProgress=0,this.gravity=Math.min(this.pf.height,this.gravity*B))}play(){w.shuffle(),setInterval(()=>{this.currentPiece!==void 0&&this.currentPiece.position===void 0&&(this.currentPiece.position=[Math.floor(this.pf.width/2-this.currentPiece.width/2),0]);const t=this.pf.overlay(this.currentPiece);switch(this.state){case l.Menu:this.renderer.drawMenu(),this.renderer.blankCanvas(this.renderer.nextCtx);break;case l.Running:this.isPieceLanded()?this.lockTimeout===void 0&&(this.lockTimeout=setTimeout(()=>{this.isPieceLanded()&&this.lockPiece(),clearTimeout(this.lockTimeout),this.lockTimeout=void 0},O)):this.doFall(),this.renderer.drawGame(t),this.renderer.drawNext(this.nextPiece);break;case l.GameOver:this.renderer.drawTextOverlay(t,"Game Over");break;case l.Paused:this.renderer.drawTextOverlay(t,"Paused");break}},this.frameDelay)}}window.addEventListener("load",K);function K(){const i=document.getElementById("gameCanvas"),t=document.getElementById("nextCanvas"),e=new Y({fieldCanvas:i,nextCanvas:t});window.addEventListener("keydown",s=>{e.handleKeyDown(s)}),window.addEventListener("keyup",s=>{e.handleKeyUp(s)}),e.play()}
